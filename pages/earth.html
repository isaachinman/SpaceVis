<!-- CYLINDER PAGE -->

<div id="loader-container" class="absolute"><div id="spinner"></div></div>

<div class="container">

<div class="row">

<div class="span12 text-center" style="align-items:center;">

    <div id="cesiumContainer" class="rounded-corners"></div>

    <button id="getImages" onclick="getSatelliteImages();">Get Images</button>

    <div id="credits"></div>

</div><!-- end span12 -->

</div><!-- end row -->

</div><!-- end container -->

<script>

// START LOADER
$("#cesiumContainer").css("visibility", "hidden");
$("#spinner").addClass("loader");

setTimeout(function() {
    $("#cesiumContainer").css("visibility", "visible");
    $("#spinner").removeClass("loader");
}, 500);


// SET BING MAPS API KEY
Cesium.BingMapsApi.defaultKey = 'AlcBeUGZSauWjGDUGdGOI_-In-0ucLbGaX8KQqk1ig8gn2Va2DmjUH_qMnxhGLu1';

// CREATE VIEWER
var earthViewer = new Cesium.Viewer('cesiumContainer', {

    animation: false,
    timeline: false,
    fullscreenButton: false,
    infoBox: false,
    sceneModePicker: false,
    selectionModePicker: false,
    selectionIndicator: false,
    baseLayerPicker: false,
    timeline: false,
    navigationHelpButton: false,
    navigationInstructionsInitiallyVisible: false,
    skyBox: false,
    skyAtmosphere: false,
    creditContainer: "credits",

    contextOptions : {
        webgl: {
            alpha: true
        }
    }
});

// SET VIEWER BACKGROUND TO TRANSPARENT
earthViewer.scene.backgroundColor = Cesium.Color.TRANSPARENT;

// SET MIN AND MAX ZOOM LEVELS
earthViewer.scene.screenSpaceCameraController.maximumZoomDistance = 100000000;
earthViewer.scene.screenSpaceCameraController.minimumZoomDistance = 10000;

// ADD IMAGERY LAYER
var earthLayers = earthViewer.imageryLayers;
earthLayers.alpha = 0.5;

function getSatelliteImages() {
    // GET LATITUDE AND LONGITUDE OF CENTER OF MAP
    //var locationArray = window.earth.getCenter();
    var requestedLatitude = 55.9520600;
    var requestedLongitude = -3.1964800;

    for (var i=-0.25; i<=-0.175; i+=0.025) {

        for (var j=-0.25; j<=-0.175; j+=0.025) {

            var adjustedLatitude = (requestedLatitude + i);
            var adjustedLongitude = (requestedLongitude + j);

            // SET UP XML SEARCH REQUEST
            var searchUrl = "https://api.nasa.gov/planetary/earth/imagery?lon=" + adjustedLongitude + "&lat=" + adjustedLatitude + "&cloud_score=True&api_key=5iF1Ge5myl5KDyqPuyZ1XxQyAMCNxbCt0dlR3M7R";
            var searchXml = new XMLHttpRequest();
            searchXml.open('GET', searchUrl, true);

            // SEND XML SEARCH REQUEST
            searchXml.send(null);

            function returnHandler(val, searchXml, adjustedLatitude, adjustedLongitude) {

                // WHEN REQUEST IS READY, PARSE RESULTS
                searchXml.onreadystatechange=function() {
                    if (searchXml.readyState==4 && searchXml.status==200) {
                        var requestedLocation = JSON.parse(searchXml.responseText);

                        console.log(adjustedLatitude, adjustedLongitude, requestedLocation);

                        /*
                        if (typeof requestedLocation.url != 'undefined') {

                            earthLayers.addImageryProvider(new Cesium.SingleTileImageryProvider({
                                url: requestedLocation.url,
                                rectangle: Cesium.Rectangle.fromDegrees((adjustedLongitude-.0125),(adjustedLatitude-.0125),(adjustedLongitude+.0125),(adjustedLatitude+.0125)),
                                parameters: {
                                    transparent: 'true',
                                    format: 'image/png'
                                },
                            }));
                        }
                        */
                    }
                }
            }
            returnHandler(i, searchXml, adjustedLatitude, adjustedLongitude);
        }
    }
}




/*

// CREATE 3D EARTH AND GIVE IT A TILELAYER
function initialiseEarth() {
    window.earth = new WE.map('earth');
    WE.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(window.earth);

    // SET PARAMETERS
    window.earth.setMinAltitude(10000);
    window.earth.setMaxAltitude(100000000);
}

// INITIALISE EARTH WHEN DOM HAS LOADED
$(document).ready(function() {
    initialiseEarth();
});

// FETCH CURRENT LAT/LONG AND RETRIEVE MOST RECENT LANDSAT IMAGE
function getSatelliteImage() {

    // GET LATITUDE AND LONGITUDE OF CENTER OF MAP
    var locationArray = window.earth.getCenter();
    var requestedLatitude = locationArray[0];
    var requestedLongitude = locationArray[1];

    for (var i=-0.25; i<=0.25; i+=0.025) {

        // SET UP XML SEARCH REQUEST
        var searchUrl = "https://api.nasa.gov/planetary/earth/imagery?lon=" + (requestedLongitude + i) + "&lat=" + (requestedLatitude + i) + "&cloud score=True&api_key=5iF1Ge5myl5KDyqPuyZ1XxQyAMCNxbCt0dlR3M7R";
        var searchXml = new XMLHttpRequest();
        searchXml.open('GET', searchUrl, true);

        // SEND XML SEARCH REQUEST
        searchXml.send(null);

        function returnHandler(val, searchXml) {
            console.log(val, searchXml);
        // WHEN REQUEST IS READY, PARSE RESULTS
            searchXml.onreadystatechange=function() {
                if (searchXml.readyState==4 && searchXml.status==200) {
                    var requestedLocation = JSON.parse(searchXml.responseText);


                        var bounds = [[((requestedLatitude + i)),((requestedLongitude + i))], [((requestedLatitude + i)+.0000001),((requestedLongitude = i)+.0000001)]];

                        newTile = L.imageOverlay(requestedLocation.url, {
                            bounds: bounds,
                            center: [(requestedLatitude + i),(requestedLongitude + i)],
                            tileSize: 512,
                            minZoom: 13,
                            maxZoom: 13,
                            opacity: 0.95
                        });

                        newTile.addTo(window.earth);


                }
            }
        }
        returnHandler(i, searchXml);
    }
}

// REMOVE ALL INFO ATTRIBUTES AND CLEAR IMAGE URL
function clearImage() {
    $('#satelliteImage').empty();
    $('#dateTaken').empty();
    $('#imageLatitude').empty();
    $('#imageLongitude').empty();
    $('#satelliteImageContainer').addClass('hidden');
    $('#imageInfo').addClass('hidden');
}

*/


</script>
