<!-- CYLINDER PAGE -->

<div id="loader-container" class="absolute"><div id="spinner"></div></div>

<div class="container">

<div class="row">

<div class="span12 text-center" style="align-items:center;">

    <div id="cesiumContainer" class="rounded-corners"></div>

    <button id="getImages" onclick="getSatelliteImages();">Get Images</button>

    <div id="credits"></div>

</div><!-- end span12 -->

</div><!-- end row -->

</div><!-- end container -->

<script>

// START LOADER
$("#cesiumContainer").css("visibility", "hidden");
$("#spinner").addClass("loader");

setTimeout(function() {
    $("#cesiumContainer").css("visibility", "visible");
    $("#spinner").removeClass("loader");
}, 500);


// SET BING MAPS API KEY
Cesium.BingMapsApi.defaultKey = 'AlcBeUGZSauWjGDUGdGOI_-In-0ucLbGaX8KQqk1ig8gn2Va2DmjUH_qMnxhGLu1';

// CREATE VIEWER
var earthViewer = new Cesium.Viewer('cesiumContainer', {

    animation: false,
    timeline: false,
    fullscreenButton: false,
    infoBox: false,
    sceneModePicker: false,
    selectionModePicker: false,
    selectionIndicator: false,
    baseLayerPicker: false,
    timeline: false,
    navigationHelpButton: false,
    navigationInstructionsInitiallyVisible: false,
    skyBox: false,
    skyAtmosphere: false,
    creditContainer: "credits",

    contextOptions : {
        webgl: {
            alpha: true
        }
    }
});

// SET VIEWER BACKGROUND TO TRANSPARENT
earthViewer.scene.backgroundColor = Cesium.Color.TRANSPARENT;

// SET MIN AND MAX ZOOM LEVELS
earthViewer.scene.screenSpaceCameraController.maximumZoomDistance = 100000000;
earthViewer.scene.screenSpaceCameraController.minimumZoomDistance = 10000;

// ADD IMAGERY LAYER
var earthLayers = earthViewer.imageryLayers;
earthLayers.alpha = 0.25;

/*
function getSatelliteImages() {

    var i = 0;

    var requestedLatitude = 55.9520600;
    var requestedLongitude = -3.1964800;

    setInterval(function() {
        i++;

        var xoffset = (i % 20 - 10) / 40;
        var yoffset = (i / 20 - 10) / 40;

        var adjustedLatitude = (requestedLatitude + xoffset);
        var adjustedLongitude = (requestedLongitude + yoffset);

        // SET UP XML SEARCH REQUEST
        var searchUrl = "https://api.nasa.gov/planetary/earth/imagery?lon=" + adjustedLongitude + "&lat=" + adjustedLatitude + "&cloud_score=True&api_key=5iF1Ge5myl5KDyqPuyZ1XxQyAMCNxbCt0dlR3M7R";
        var searchXml = new XMLHttpRequest();
        searchXml.open('GET', searchUrl, true);

        // SEND XML SEARCH REQUEST
        searchXml.send(null);

        function returnHandler(val, searchXml, adjustedLatitude, adjustedLongitude) {

            // WHEN REQUEST IS READY, PARSE RESULTS
            searchXml.onreadystatechange=function() {
                if (searchXml.readyState==4 && searchXml.status==200) {
                    var requestedLocation = JSON.parse(searchXml.responseText);

                    console.log(adjustedLatitude, adjustedLongitude, requestedLocation.error);

                    if (typeof requestedLocation.error == 'undefined') {

                        earthLayers.addImageryProvider(new Cesium.SingleTileImageryProvider({
                            url: requestedLocation.url,
                            rectangle: Cesium.Rectangle.fromDegrees((adjustedLongitude-.0125),(adjustedLatitude-.0125),(adjustedLongitude+.0125),(adjustedLatitude+.0125)),
                            parameters: {
                                transparent: 'true',
                                format: 'image/png'
                            },
                        }));
                    }
                }
            }
        }
        returnHandler(i, searchXml, adjustedLatitude, adjustedLongitude);
    }, 1000);
}
*/


function getSatelliteImages() {

    function getCenterCoordinates() {
        var windowPosition = new Cesium.Cartesian2(earthViewer.container.clientWidth / 2, earthViewer.container.clientHeight / 2);
        var pickRay = earthViewer.scene.camera.getPickRay(windowPosition);
        var pickPosition = earthViewer.scene.globe.pick(pickRay, earthViewer.scene);
        var pickPositionCartographic = earthViewer.scene.globe.ellipsoid.cartesianToCartographic(pickPosition);
        window.centerLatitude = Cesium.Math.toDegrees(pickPositionCartographic.latitude);
        window.centerLongitude = Cesium.Math.toDegrees(pickPositionCartographic.longitude);
        console.log(window.centerLatitude, window.centerLongitude);
    }
    getCenterCoordinates();

    // GET LATITUDE AND LONGITUDE OF CENTER OF MAP
    var requestedLatitude = window.centerLatitude;
    var requestedLongitude = window.centerLongitude;

    for (var i=-0.025; i<=0; i+=0.025) {

        for (var j=-0.025; j<=0; j+=0.025) {

            var adjustedLatitude = (requestedLatitude + i);
            var adjustedLongitude = (requestedLongitude + j);

            // SET UP XML SEARCH REQUEST
            var searchUrl = "https://api.nasa.gov/planetary/earth/imagery?lon=" + adjustedLongitude + "&lat=" + adjustedLatitude + "&cloud_score=True&api_key=5iF1Ge5myl5KDyqPuyZ1XxQyAMCNxbCt0dlR3M7R";
            var searchXml = new XMLHttpRequest();
            searchXml.open('GET', searchUrl, true);

            // SEND XML SEARCH REQUEST
            searchXml.send(null);

            function returnHandler(val, searchXml, adjustedLatitude, adjustedLongitude) {

                // WHEN REQUEST IS READY, PARSE RESULTS
                searchXml.onreadystatechange=function() {
                    if (searchXml.readyState==4 && searchXml.status==200) {
                        var requestedLocation = JSON.parse(searchXml.responseText);

                        console.log(adjustedLatitude, adjustedLongitude, requestedLocation.error);

                        if (typeof requestedLocation.error == 'undefined') {

                            earthLayers.addImageryProvider(new Cesium.SingleTileImageryProvider({
                                url: requestedLocation.url,
                                rectangle: Cesium.Rectangle.fromDegrees((adjustedLongitude-.0125),(adjustedLatitude-.0125),(adjustedLongitude+.0125),(adjustedLatitude+.0125)),
                                parameters: {
                                    transparent: 'true',
                                    format: 'image/png'
                                },
                            }));
                        }
                    }
                }
            }
            returnHandler(i, searchXml, adjustedLatitude, adjustedLongitude);
        }
    }
}

</script>
